# PRD: GL-02 Journal Entry

> **Cell Code:** GL-02  
> **Domain:** General Ledger (DOM-05)  
> **Status:** üü° Design Phase ‚Äî Awaiting User Review  
> **Created:** 2025-12-17  
> **Author:** AI-BOS Architecture Team

---

## 0. Executive Summary

The **Journal Entry (JE)** cell is the **manual interface** for recording adjusting entries, accruals, reclassifications, and other non-automated accounting transactions. It serves as the "catch-all" mechanism for entries that don't originate from AP/AR/Treasury cells.

**Why This Cell Exists:** While most journal entries are automatically generated by source systems (AP invoices, AR receipts, payments), there will always be manual adjustments needed (month-end accruals, error corrections, reclassifications). GL-02 provides a controlled, audited interface for these entries.

**AIS Justification (Romney & Steinbart):**  
The **Journalizing Process** is a fundamental step in the accounting cycle. Manual journal entries are necessary for adjustments that cannot be automated, ensuring the completeness and accuracy of financial records.

**COSO Mapping:**  
- **Control Activity:** Authorization control ‚Äî manual entries require approval before posting
- **Assertion:** Accuracy & Completeness ‚Äî ensures all necessary adjustments are recorded

---

## 1. Business Justification

### 1.1 Problem Statement

**Current Pain Points:**
- ‚ùå No standardized way to record manual accounting entries
- ‚ùå Adjustments bypass approval workflows (Excel ‚Üí direct posting)
- ‚ùå Lack of traceability for manual entries (who, why, when)
- ‚ùå No validation before posting (unbalanced entries slip through)
- ‚ùå Period cutoff violations (posting to closed periods)

### 1.2 Success Criteria

| # | Metric | Target | Measurement |
|---|--------|--------|-------------|
| 1 | **Balanced Entry Enforcement** | 100% | No unbalanced entries can be submitted |
| 2 | **Approval Coverage** | 100% | All manual entries approved before posting |
| 3 | **Period Cutoff Compliance** | 100% | Cannot post to closed periods |
| 4 | **Audit Trail** | 100% | Every JE has who/what/when/why documentation |
| 5 | **SoD Enforcement** | 0 violations | Creator ‚â† Approver ‚â† Poster |

---

## 2. Scope Definition

### 2.1 IN SCOPE

‚úÖ **Manual Journal Entry Creation**
- Multi-line entries with debits/credits
- Account validation against GL-01 (COA)
- Balance validation (sum debits = sum credits)
- Attachment support (supporting documents, Excel files)
- Business justification (required field)

‚úÖ **Journal Entry Workflow**
- Submit for approval
- Multi-level approval (amount-based)
- Rejection with reason
- Resubmission after edits

‚úÖ **Reversing Entries**
- Auto-reverse flag (reverses in next period)
- Manual reversal creation (creates matching reverse entry)

‚úÖ **Recurring Journal Entries**
- Template creation
- Scheduled posting (monthly accruals, depreciation)
- One-time vs. recurring flag

‚úÖ **Journal Entry Types**
- Adjusting Entry (AJE)
- Accrual Entry
- Reclassification
- Opening Balance
- Closing Entry
- Reversal Entry
- Correction Entry

### 2.2 OUT OF SCOPE

‚ùå **Automated Entries** ‚Äî Created by AP/AR/TR cells, not manual
‚ùå **Posting Engine Logic** ‚Äî That's GL-03 (this cell only creates entries)
‚ùå **Trial Balance** ‚Äî That's GL-05
‚ùå **Financial Reporting** ‚Äî Separate reporting domain
‚ùå **Budget vs. Actual** ‚Äî Future cell

---

## 3. Functional Requirements

### 3.1 Journal Entry Lifecycle State Machine

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              JOURNAL ENTRY LIFECYCLE                         ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ   DRAFT ‚îÄ‚îÄ‚ñ∫ SUBMITTED ‚îÄ‚îÄ‚ñ∫ APPROVED ‚îÄ‚îÄ‚ñ∫ POSTED ‚îÄ‚îÄ‚ñ∫ CLOSED    ‚îÇ
‚îÇ      ‚îÇ           ‚îÇ           ‚îÇ                               ‚îÇ
‚îÇ      ‚îÇ           ‚îÇ           ‚îî‚îÄ‚îÄ‚ñ∫ REJECTED ‚îÄ‚îÄ‚ñ∫ CANCELLED     ‚îÇ
‚îÇ      ‚îÇ           ‚îÇ                   ‚îÇ                       ‚îÇ
‚îÇ      ‚îÇ           ‚îÇ                   ‚îî‚îÄ‚îÄ‚ñ∫ DRAFT (edit)       ‚îÇ
‚îÇ      ‚îÇ           ‚îÇ                                           ‚îÇ
‚îÇ      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚ñ∫ CANCELLED                              ‚îÇ
‚îÇ                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

| State | Description | Editable? | Next States |
|-------|-------------|-----------|-------------|
| **DRAFT** | Being created | ‚úÖ Yes | SUBMITTED, CANCELLED |
| **SUBMITTED** | Awaiting approval | ‚ùå No | APPROVED, REJECTED |
| **APPROVED** | Ready for posting | ‚ùå No | POSTED |
| **POSTED** | Recorded in GL | ‚ùå No | CLOSED (after period close) |
| **REJECTED** | Approval denied | ‚ùå No | DRAFT (edit), CANCELLED |
| **CANCELLED** | Withdrawn | ‚ùå No | None (terminal) |
| **CLOSED** | Period closed | ‚ùå No | None (terminal) |

### 3.2 Core Operations

#### 3.2.1 Create Journal Entry

**Input:**
```typescript
{
  companyId: string;
  entryDate: Date;              // Posting date
  entryType: 'adjusting' | 'accrual' | 'reclassification' | 'opening' | 'closing' | 'reversal' | 'correction';
  reference: string;            // "AJE-2024-001", "ACR-2024-12-31"
  description: string;          // Business justification (required)
  
  lines: JournalEntryLine[];    // Min 2 lines (at least 1 debit, 1 credit)
  
  isRecurring: boolean;
  recurringSchedule?: {
    frequency: 'monthly' | 'quarterly' | 'yearly';
    startDate: Date;
    endDate?: Date;
  };
  
  autoReverse: boolean;         // Auto-reverse in next period?
  reverseDate?: Date;
  
  attachments?: {
    filename: string;
    fileUrl: string;
    fileType: string;
  }[];
  
  tags?: string[];
}

interface JournalEntryLine {
  accountCode: string;
  debitAmount?: Money;          // Either debit or credit, not both
  creditAmount?: Money;
  costCenter?: string;
  department?: string;
  project?: string;
  memo?: string;
}
```

**Validations:**
- Entry date must be in an open period (K_TIME check)
- All account codes must exist and be active (GL-01 validation)
- All accounts must be postable (not summary accounts)
- **Balanced entry:** `SUM(debits) = SUM(credits)` per currency
- Minimum 2 lines
- Each line must have either debit OR credit (not both, not neither)
- Description is mandatory (business justification)
- Reference must be unique per company

**Business Rules:**
- Auto-reverse entries cannot be recurring
- Closing entries can only be posted on last day of period
- Opening entries can only be posted on first day of period

**Output:**
- Created journal entry (status: DRAFT)
- Entry number assigned
- Audit event: `gl.journal.created`

#### 3.2.2 Submit for Approval

**Input:**
```typescript
{
  journalEntryId: string;
  submissionNotes?: string;
}
```

**Validations:**
- Entry must be in DRAFT status
- Entry must be balanced
- All required fields filled (description, lines)
- Period must still be open

**Approval Routing Logic:**
```typescript
// Amount-based approval routing
const totalAmount = Math.abs(sum(debits)); // or sum(credits), same value

if (totalAmount >= 1_000_000) {
  requiredApprovers = ['controller', 'cfo'];
} else if (totalAmount >= 100_000) {
  requiredApprovers = ['controller'];
} else if (totalAmount >= 10_000) {
  requiredApprovers = ['manager'];
} else {
  requiredApprovers = ['senior_accountant'];
}
```

**Output:**
- Entry status ‚Üí SUBMITTED
- Approval request created
- Notification sent to approver(s)
- Audit event: `gl.journal.submitted`

#### 3.2.3 Approve Journal Entry

**Requires:** SoD enforcement (approver ‚â† creator)

**Input:**
```typescript
{
  journalEntryId: string;
  approvalNotes?: string;
}
```

**Validations:**
- Entry must be in SUBMITTED status
- Approver has required role/permission
- Approver ‚â† Creator (SoD)
- Period still open (haven't closed since submission)

**Output:**
- Entry status ‚Üí APPROVED
- Approval record created (timestamp, approver ID)
- Entry ready for posting
- Audit event: `gl.journal.approved`

#### 3.2.4 Reject Journal Entry

**Input:**
```typescript
{
  journalEntryId: string;
  rejectionReason: string;      // Mandatory
  suggestedChanges?: string;
}
```

**Validations:**
- Entry must be in SUBMITTED status
- Rejection reason is mandatory

**Output:**
- Entry status ‚Üí REJECTED
- Creator notified with rejection reason
- Audit event: `gl.journal.rejected`

#### 3.2.5 Post Journal Entry

**Handled by:** GL-03 (Posting Engine), but initiated from GL-02

**Trigger:** After approval, entry is automatically queued for posting

**Validations (by GL-03):**
- Entry status = APPROVED
- Period still open
- Accounts still active
- No currency mismatches

**Output:**
- Entry status ‚Üí POSTED
- Journal lines written to ledger (GL-03)
- GL posting reference assigned
- If auto-reverse, reversal entry created for next period
- Audit event: `gl.journal.posted`

#### 3.2.6 Reverse Journal Entry

**Input:**
```typescript
{
  originalJournalEntryId: string;
  reversalDate: Date;
  reversalReason: string;
}
```

**Process:**
1. Validate original entry is POSTED
2. Create new journal entry (type: REVERSAL)
3. Copy all lines but flip debit/credit
4. Link to original entry
5. Submit for approval (follows same workflow)

**Output:**
- New journal entry created (type: REVERSAL, status: DRAFT)
- Original entry marked with `has_reversal = true`
- Audit event: `gl.journal.reversal_created`

---

## 4. Control Points

### 4.1 Segregation of Duties (SoD)

| Action | Creator | Approver | Poster | Notes |
|--------|---------|----------|--------|-------|
| Create Entry | ‚úÖ Accountant | ‚ùå | ‚ùå | Maker |
| Submit | ‚úÖ Creator | ‚ùå | ‚ùå | ‚Äî |
| Approve | ‚ùå Cannot be creator | ‚úÖ Manager+ | ‚ùå | Checker |
| Post | ‚ùå | ‚ùå | ‚úÖ GL-03 (system) | Automated |

**Database Constraint:**
```sql
CHECK (approved_by IS NULL OR approved_by <> created_by)
```

### 4.2 Approval Limits

| Total Amount | Required Approver | Rationale |
|--------------|-------------------|-----------|
| < $10,000 | Senior Accountant | Low risk |
| $10,000 - $99,999 | Manager | Medium risk |
| $100,000 - $999,999 | Controller | High risk |
| ‚â• $1,000,000 | Controller + CFO | Very high risk |

### 4.3 Period Cutoff

**Rule:** Cannot create/submit/approve/post entries for closed periods.

**Validation:**
```typescript
const periodStatus = await K_TIME.isPeriodOpen(entry.entry_date);
if (!periodStatus.can_post) {
  throw new PeriodClosedError(periodStatus.period_name);
}
```

**Exception:** Controlled Reopen (per CONT_07 Section 3.2.3) allows corrections.

### 4.4 Audit Requirements

Every state transition **MUST** log:

| Event Type | Logged Data |
|------------|-------------|
| `gl.journal.created` | Full entry payload, line items, creator ID |
| `gl.journal.submitted` | Entry ID, total amount, submission timestamp |
| `gl.journal.approved` | Entry ID, approver ID, approval timestamp |
| `gl.journal.rejected` | Entry ID, rejector ID, rejection reason |
| `gl.journal.posted` | Entry ID, GL posting ref, posting timestamp |
| `gl.journal.reversal_created` | Original entry ID, reversal entry ID, reason |

---

## 5. GL Impact

**GL Posting:** This cell **creates** journal entries but **does NOT post** them.

**Posting handled by:** GL-03 (Posting Engine)

**Flow:**
```
GL-02 (Create Entry) ‚Üí Approval Workflow ‚Üí GL-03 (Post to Ledger)
```

**Journal Entry Structure:**
```
Entry: AJE-2024-001
Date: 2024-12-31
Description: Accrual for December utilities
Status: APPROVED

Lines:
  Dr: 5100 (Utilities Expense)      $1,200.00
  Cr: 2300 (Accrued Expenses)       $1,200.00
  
Total Debit:  $1,200.00
Total Credit: $1,200.00
Balanced: ‚úÖ
```

---

## 6. Data Model

### 6.1 Primary Entity: `gl_journal_entries`

```typescript
interface JournalEntry {
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // IDENTITY
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  id: string;                      // UUID
  tenant_id: string;
  company_id: string;
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ENTRY METADATA
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  entry_number: string;            // "JE-2024-001234"
  entry_date: Date;                // Posting date
  entry_type: JournalEntryType;
  reference: string;               // External reference
  description: string;             // Business justification (required)
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // AMOUNTS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  total_debit: Money;              // Sum of all debit lines
  total_credit: Money;             // Sum of all credit lines
  currency: string;                // ISO 4217
  is_balanced: boolean;            // Auto-calculated
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // LIFECYCLE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  status: JournalEntryStatus;
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // REVERSAL HANDLING
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  auto_reverse: boolean;
  reverse_date?: Date;
  original_entry_id?: string;      // If this is a reversal
  has_reversal: boolean;           // If this entry has been reversed
  reversal_entry_id?: string;
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // RECURRING
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  is_recurring: boolean;
  recurring_frequency?: 'monthly' | 'quarterly' | 'yearly';
  recurring_start_date?: Date;
  recurring_end_date?: Date;
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // WORKFLOW
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  submitted_at?: Date;
  submitted_by?: string;
  approved_at?: Date;
  approved_by?: string;
  rejected_at?: Date;
  rejected_by?: string;
  rejection_reason?: string;
  posted_at?: Date;
  posted_by?: string;              // Usually system
  gl_posting_reference?: string;   // Link to GL-03 posting
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ATTACHMENTS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  attachments: Attachment[];
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // AUDIT TRAIL
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  created_by: string;
  created_at: Date;
  updated_by?: string;
  updated_at?: Date;
  version: number;
}
```

### 6.2 Child Entity: `gl_journal_lines`

```typescript
interface JournalEntryLine {
  id: string;
  journal_entry_id: string;        // FK
  line_number: number;             // 1, 2, 3...
  
  account_code: string;
  account_name: string;            // Denormalized for performance
  
  debit_amount?: Money;
  credit_amount?: Money;
  
  cost_center?: string;
  department?: string;
  project?: string;
  
  memo?: string;
  
  created_at: Date;
}
```

### 6.3 Enums

```typescript
enum JournalEntryType {
  ADJUSTING = 'adjusting',
  ACCRUAL = 'accrual',
  RECLASSIFICATION = 'reclassification',
  OPENING = 'opening',
  CLOSING = 'closing',
  REVERSAL = 'reversal',
  CORRECTION = 'correction'
}

enum JournalEntryStatus {
  DRAFT = 'draft',
  SUBMITTED = 'submitted',
  APPROVED = 'approved',
  REJECTED = 'rejected',
  POSTED = 'posted',
  CANCELLED = 'cancelled',
  CLOSED = 'closed'
}
```

### 6.4 Indexes

```sql
CREATE INDEX idx_je_company_date ON gl_journal_entries(company_id, entry_date);
CREATE INDEX idx_je_status ON gl_journal_entries(status);
CREATE INDEX idx_je_created_by ON gl_journal_entries(created_by);
CREATE INDEX idx_je_approved_by ON gl_journal_entries(approved_by);
CREATE INDEX idx_je_reversal ON gl_journal_entries(original_entry_id) WHERE original_entry_id IS NOT NULL;
```

### 6.5 Constraints

```sql
-- Balanced entry
ALTER TABLE gl_journal_entries
ADD CONSTRAINT chk_je_balanced
CHECK (total_debit = total_credit);

-- SoD: Approver cannot be creator
ALTER TABLE gl_journal_entries
ADD CONSTRAINT chk_je_sod
CHECK (approved_by IS NULL OR approved_by <> created_by);

-- Each line has debit XOR credit
ALTER TABLE gl_journal_lines
ADD CONSTRAINT chk_line_debit_xor_credit
CHECK ((debit_amount IS NOT NULL AND credit_amount IS NULL) 
    OR (debit_amount IS NULL AND credit_amount IS NOT NULL));
```

---

## 7. Dependencies

### 7.1 Kernel Services Required

| Service | Usage | Criticality |
|---------|-------|-------------|
| **K_TIME** | Period open validation | üî¥ Blocking |
| **K_AUTH** | Identity, SoD enforcement | üî¥ Blocking |
| **K_LOG** | Audit trail | üî¥ Blocking |
| **K_POLICY** | Approval routing | üî¥ Blocking |
| **K_SEQ** | Entry number generation | üî¥ Blocking |

### 7.2 Upstream Dependencies

| Cell | Dependency | Usage |
|------|------------|-------|
| **GL-01** (COA) | Account validation | Validate account codes exist, active, postable |

### 7.3 Downstream Dependencies

| Cell | Usage |
|------|-------|
| **GL-03** (Posting Engine) | Posts approved entries to ledger |

---

## 8. Non-Functional Requirements

### 8.1 Performance

| Operation | Target | Measurement |
|-----------|--------|-------------|
| **Create Entry** | < 500ms | End-to-end |
| **Submit for Approval** | < 200ms | ‚Äî |
| **Approve Entry** | < 300ms | ‚Äî |
| **List Entries** | < 300ms | Page of 50 entries |

### 8.2 Security

- **Field-Level Encryption:** Attachments, descriptions
- **Access Control:** Role-based (Accountant, Manager, Controller)
- **Audit Logging:** Every state change logged

### 8.3 Scalability

- **Expected Volume:** ~500 manual entries per month per company
- **Max Lines per Entry:** 100 lines
- **Attachment Size Limit:** 10MB per file

### 8.4 Availability

- **Uptime SLA:** 99.9%
- **RPO:** 5 minutes
- **RTO:** 1 hour

---

## 9. Edge Cases & Error Scenarios

| # | Scenario | Expected Behavior |
|---|----------|------------------|
| 1 | **Unbalanced entry submission** | Reject with `ENTRY_NOT_BALANCED` |
| 2 | **Post to closed period** | Reject with `PERIOD_CLOSED` |
| 3 | **Approve own entry** | Reject with `SOD_VIOLATION` |
| 4 | **Invalid account code** | Reject with `ACCOUNT_NOT_FOUND` |
| 5 | **Summary account in line** | Reject with `ACCOUNT_NOT_POSTABLE` |
| 6 | **Concurrent approval (2 approvers)** | First approval wins, second gets `VERSION_CONFLICT` |
| 7 | **Edit after submission** | Reject with `ENTRY_NOT_EDITABLE` (must reject first) |
| 8 | **Auto-reverse + recurring** | Reject with `INVALID_CONFIGURATION` |
| 9 | **Missing description** | Reject with `DESCRIPTION_REQUIRED` |
| 10 | **Period closes before approval** | Reject approval with `PERIOD_NOW_CLOSED` |

---

## 10. Test Strategy

### 10.1 Unit Tests

- [ ] Create balanced entry
- [ ] Create unbalanced entry (reject)
- [ ] Submit for approval
- [ ] Approve entry
- [ ] Approve own entry (SoD violation)
- [ ] Reject entry with reason
- [ ] Post to closed period (reject)
- [ ] Create reversal entry
- [ ] Auto-reverse flag triggers reversal
- [ ] Multi-line entry with different accounts

### 10.2 SoD Tests

- [ ] `test_creator_cannot_approve_own_entry()`
- [ ] `test_different_user_can_approve()`
- [ ] `test_system_enforces_sod_at_db_level()`

### 10.3 Integration Tests

- [ ] Create ‚Üí Submit ‚Üí Approve ‚Üí Post (happy path)
- [ ] Create ‚Üí Submit ‚Üí Reject ‚Üí Edit ‚Üí Resubmit
- [ ] Reversal entry creates opposite lines
- [ ] Period closes before approval (reject approval)
- [ ] Account validation against GL-01

### 10.4 Control Tests

- [ ] `test_audit_event_on_create()`
- [ ] `test_audit_event_on_approve()`
- [ ] `test_period_cutoff_enforced()`
- [ ] `test_balance_constraint_at_db_level()`

---

## 11. Success Metrics (Post-Implementation)

| Metric | Target | How Measured |
|--------|--------|--------------|
| **Balanced Entry Enforcement** | 100% | Count of unbalanced submissions blocked |
| **SoD Violations Blocked** | 100% | Count of self-approvals rejected |
| **Period Cutoff Compliance** | 100% | Count of closed period rejections |
| **Average Approval Time** | < 2 hours | Time from submission to approval |
| **Dashboard Health Score** | > 90 | Based on pending approvals, rejected entries |

---

## 12. Open Questions (for User Review)

1. **Multi-Level Approval:** Should high-value entries require CFO approval in addition to Controller?
2. **Recurring Entry Automation:** Should recurring entries auto-post without approval after first approval?
3. **Attachment Requirements:** Should certain entry types (e.g., corrections) require mandatory attachments?
4. **Edit After Rejection:** Should rejected entries be editable, or must creator withdraw and recreate?
5. **Inter-Company Entries:** Should GL-02 support inter-company journal entries, or is that a separate cell?

---

## 13. Document Control

| Property | Value |
|----------|-------|
| **Cell Code** | GL-02 |
| **PRD Version** | 1.0 |
| **Status** | üü° Awaiting User Review |
| **Author** | AI-BOS Architecture Team |
| **Created** | 2025-12-17 |
| **Quality Gate** | 1 of 2 (PRD Review) |

---

**üî¥ USER ACTION REQUIRED:**  
Please review this PRD against the Quality Gate Checklist (Appendix J in CONT_07).  
**Approve** this design to proceed to Architecture Review, or **Provide Feedback** for revision.
