# ============================================================================
# AI-BOS Database Validation CI
# MVP Task 9: Schema CI
# 
# Validates database migrations on every PR that touches apps/db/
# ============================================================================

name: Database Validation

on:
  pull_request:
    paths:
      - 'apps/db/migrations/**'
      - 'apps/db/tests/**'
      - 'apps/db/lib/**'
      - 'apps/db/package.json'
  push:
    branches:
      - main
      - master
    paths:
      - 'apps/db/migrations/**'

env:
  DATABASE_URL: postgres://aibos:aibos_password@localhost:5432/aibos_test
  POSTGRES_USER: aibos
  POSTGRES_PASSWORD: aibos_password
  POSTGRES_DB: aibos_test

jobs:
  # ============================================================================
  # Job 1: Lint Migrations with Squawk
  # ============================================================================
  lint-migrations:
    name: Lint Migrations
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Squawk
        run: npm install -g squawk-cli

      - name: Lint Kernel Migrations
        run: |
          echo "üîç Linting kernel migrations..."
          squawk apps/db/migrations/kernel/*.sql || true
        continue-on-error: true

      - name: Lint Finance Migrations
        run: |
          echo "üîç Linting finance migrations..."
          squawk apps/db/migrations/finance/*.sql || true
        continue-on-error: true

      - name: Lint Config Migrations
        run: |
          echo "üîç Linting config migrations..."
          squawk apps/db/migrations/config/*.sql || true
        continue-on-error: true

  # ============================================================================
  # Job 2: Test Migrations Apply Successfully
  # ============================================================================
  test-migrations:
    name: Test Migrations
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: aibos
          POSTGRES_PASSWORD: aibos_password
          POSTGRES_DB: aibos_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install Dependencies
        run: pnpm install --filter @aibos/db

      - name: Create Schemas
        run: |
          PGPASSWORD=$POSTGRES_PASSWORD psql -h localhost -U $POSTGRES_USER -d $POSTGRES_DB -c "
            CREATE SCHEMA IF NOT EXISTS kernel;
            CREATE SCHEMA IF NOT EXISTS finance;
            CREATE SCHEMA IF NOT EXISTS config;
          "

      - name: Run Migrations
        run: pnpm --filter @aibos/db migrate
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

      - name: Verify Migrations Applied
        run: |
          echo "üìã Checking migration state..."
          PGPASSWORD=$POSTGRES_PASSWORD psql -h localhost -U $POSTGRES_USER -d $POSTGRES_DB -c "
            SELECT schemaname, tablename 
            FROM pg_tables 
            WHERE schemaname IN ('kernel', 'finance', 'config')
            ORDER BY schemaname, tablename;
          "

  # ============================================================================
  # Job 3: Run pgTAP Tests
  # ============================================================================
  test-pgtap:
    name: pgTAP Tests
    runs-on: ubuntu-latest
    needs: test-migrations
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: aibos
          POSTGRES_PASSWORD: aibos_password
          POSTGRES_DB: aibos_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install Dependencies
        run: pnpm install --filter @aibos/db

      - name: Create Schemas and Run Migrations
        run: |
          PGPASSWORD=$POSTGRES_PASSWORD psql -h localhost -U $POSTGRES_USER -d $POSTGRES_DB -c "
            CREATE SCHEMA IF NOT EXISTS kernel;
            CREATE SCHEMA IF NOT EXISTS finance;
            CREATE SCHEMA IF NOT EXISTS config;
          "
          pnpm --filter @aibos/db migrate
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

      - name: Install pgTAP Extension
        run: |
          PGPASSWORD=$POSTGRES_PASSWORD psql -h localhost -U $POSTGRES_USER -d $POSTGRES_DB -c "
            CREATE EXTENSION IF NOT EXISTS pgtap;
          "

      - name: Run Schema Tests
        run: |
          echo "üß™ Running schema tests..."
          for test in apps/db/tests/schema/*.sql; do
            echo "Running $test..."
            PGPASSWORD=$POSTGRES_PASSWORD psql -h localhost -U $POSTGRES_USER -d $POSTGRES_DB -f "$test" || exit 1
          done

      - name: Run Constraint Tests
        run: |
          echo "üß™ Running constraint tests..."
          for test in apps/db/tests/constraints/*.sql; do
            echo "Running $test..."
            PGPASSWORD=$POSTGRES_PASSWORD psql -h localhost -U $POSTGRES_USER -d $POSTGRES_DB -f "$test" || exit 1
          done

      - name: Run Isolation Tests (pgTAP)
        run: |
          echo "üîí Running tenant isolation tests..."
          for test in apps/db/tests/isolation/*.sql; do
            echo "Running $test..."
            PGPASSWORD=$POSTGRES_PASSWORD psql -h localhost -U $POSTGRES_USER -d $POSTGRES_DB -f "$test" || exit 1
          done

  # ============================================================================
  # Job 4: Integration Tests (Vitest)
  # ============================================================================
  test-isolation:
    name: Tenant Isolation Tests
    runs-on: ubuntu-latest
    needs: test-migrations
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: aibos
          POSTGRES_PASSWORD: aibos_password
          POSTGRES_DB: aibos_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install Dependencies
        run: pnpm install --filter @aibos/db

      - name: Create Schemas and Run Migrations
        run: |
          PGPASSWORD=$POSTGRES_PASSWORD psql -h localhost -U $POSTGRES_USER -d $POSTGRES_DB -c "
            CREATE SCHEMA IF NOT EXISTS kernel;
            CREATE SCHEMA IF NOT EXISTS finance;
            CREATE SCHEMA IF NOT EXISTS config;
            CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";
          "
          pnpm --filter @aibos/db migrate
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

      - name: Run TenantGuard Integration Tests
        run: pnpm --filter @aibos/db test:isolation
        env:
          DATABASE_URL: postgres://aibos:aibos_password@localhost:5432/aibos_test

  # ============================================================================
  # Job 5: Verify Role Separation
  # ============================================================================
  test-roles:
    name: Verify Roles
    runs-on: ubuntu-latest
    needs: test-migrations
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: aibos
          POSTGRES_PASSWORD: aibos_password
          POSTGRES_DB: aibos_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install Dependencies
        run: pnpm install --filter @aibos/db

      - name: Create Schemas and Run Migrations
        run: |
          PGPASSWORD=$POSTGRES_PASSWORD psql -h localhost -U $POSTGRES_USER -d $POSTGRES_DB -c "
            CREATE SCHEMA IF NOT EXISTS kernel;
            CREATE SCHEMA IF NOT EXISTS finance;
            CREATE SCHEMA IF NOT EXISTS config;
          "
          pnpm --filter @aibos/db migrate
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

      - name: Verify Roles
        run: pnpm --filter @aibos/db verify:roles
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

  # ============================================================================
  # Summary Job
  # ============================================================================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint-migrations, test-migrations, test-pgtap, test-isolation, test-roles]
    if: always()
    
    steps:
      - name: Check Results
        run: |
          echo "============================================"
          echo "  AI-BOS Database CI Summary"
          echo "============================================"
          echo ""
          echo "Lint Migrations:    ${{ needs.lint-migrations.result }}"
          echo "Test Migrations:    ${{ needs.test-migrations.result }}"
          echo "pgTAP Tests:        ${{ needs.test-pgtap.result }}"
          echo "Isolation Tests:    ${{ needs.test-isolation.result }}"
          echo "Role Verification:  ${{ needs.test-roles.result }}"
          echo ""
          
          if [ "${{ needs.test-migrations.result }}" != "success" ] || \
             [ "${{ needs.test-pgtap.result }}" != "success" ] || \
             [ "${{ needs.test-isolation.result }}" != "success" ] || \
             [ "${{ needs.test-roles.result }}" != "success" ]; then
            echo "‚ùå Some checks failed!"
            exit 1
          else
            echo "‚úÖ All critical checks passed!"
          fi
